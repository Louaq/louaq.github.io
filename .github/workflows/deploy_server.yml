name: ğŸš€ éƒ¨ç½²åˆ°è‡ªæœ‰æœåŠ¡å™¨

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build:
    name: ğŸ“¦ æ„å»ºé¡¹ç›®
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
          run_install: false

      - name: ğŸ“¦ è·å– pnpm å­˜å‚¨ç›®å½•
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: ğŸ”„ è®¾ç½® pnpm ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install

      - name: ğŸ”¨ æ„å»ºé¡¹ç›®
        run: pnpm build
        env:
          NODE_ENV: production

      - name: ğŸ’¾ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ°æœåŠ¡å™¨
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        server:
          - name: 'Server-1'
            host_secret: 'HOST'
            username_secret: 'USERNAME'
            ssh_key_secret: 'SSH_PRIVATE_KEY'
            port: 45663
            path: '/opt/1panel/www/sites/visualmedical.org/index'
      fail-fast: false

    steps:
      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ğŸšš å‡†å¤‡æœåŠ¡å™¨ - ${{ matrix.server.name }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets[matrix.server.host_secret] }}
          username: ${{ secrets[matrix.server.username_secret] }}
          key: ${{ secrets[matrix.server.ssh_key_secret] }}
          port: ${{ matrix.server.port }}
          script_stop: true
          script: |
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨å¹¶è®¾ç½®æƒé™
            sudo mkdir -p ${{ matrix.server.path }}
            sudo chown -R root:www-data ${{ matrix.server.path }}
            
            # æ¸…ç†ç›®æ ‡ç›®å½•
            sudo rm -rf ${{ matrix.server.path }}/*
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
            rm -rf /tmp/dist

      - name: ğŸ“¤ ä¸Šä¼ åˆ° ${{ matrix.server.name }}
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets[matrix.server.host_secret] }}
          username: ${{ secrets[matrix.server.username_secret] }}
          key: ${{ secrets[matrix.server.ssh_key_secret] }}
          port: ${{ matrix.server.port }}
          source: 'dist/*'
          target: ${{ matrix.server.path }}
          strip_components: 1

      - name: ğŸ”§ è®¾ç½®æƒé™ - ${{ matrix.server.name }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets[matrix.server.host_secret] }}
          username: ${{ secrets[matrix.server.username_secret] }}
          key: ${{ secrets[matrix.server.ssh_key_secret] }}
          port: ${{ matrix.server.port }}
          script_stop: true
          script: |
            # è®¾ç½®æ­£ç¡®çš„æƒé™
            chmod -R 755 ${{ matrix.server.path }}
            sudo chown -R root:www-data ${{ matrix.server.path }}
            
            echo "âœ… ${{ matrix.server.name }} éƒ¨ç½²å®Œæˆï¼"

      - name: âŒ éƒ¨ç½²å¤±è´¥å¤„ç† - ${{ matrix.server.name }}
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets[matrix.server.host_secret] }}
          username: ${{ secrets[matrix.server.username_secret] }}
          key: ${{ secrets[matrix.server.ssh_key_secret] }}
          port: ${{ matrix.server.port }}
          script: |
            echo "âŒ ${{ matrix.server.name }} éƒ¨ç½²å¤±è´¥ï¼Œæ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -rf /tmp/website-build /tmp/visualmedical.org_deploy.sh /tmp/dist
            echo "âš ï¸ è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—å¹¶æ‰‹åŠ¨å¤„ç†"

  notify:
    name: ğŸ“¢ éƒ¨ç½²ç»“æœé€šçŸ¥
    needs: deploy
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ ç½‘ç«™å·²æˆåŠŸéƒ¨ç½²åˆ°æ‰€æœ‰æœåŠ¡å™¨ï¼"
          
      - name: âš ï¸ éƒ¨ç½²éƒ¨åˆ†å¤±è´¥é€šçŸ¥
        if: needs.deploy.result == 'failure'
        run: |
          echo "âš ï¸ éƒ¨ç½²åˆ°éƒ¨åˆ†æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ï¼"
