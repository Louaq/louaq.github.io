name: ğŸš€ éƒ¨ç½²åˆ°è‡ªæœ‰æœåŠ¡å™¨

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: æ„å»ºå¹¶éƒ¨ç½²åˆ°æœåŠ¡å™¨
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ”¨ æ„å»ºé¡¹ç›®
        run: npm run build
        env:
          NODE_ENV: production

      - name: ğŸšš å‡†å¤‡æœåŠ¡å™¨
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨å¹¶è®¾ç½®æƒé™
            sudo mkdir -p /root/www/visualmedical.org
            sudo chown -R root:www-data /root/www/visualmedical.org
            
            # æ¸…ç†ç›®æ ‡ç›®å½•
            sudo rm -rf /root/www/visualmedical.org/*
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
            rm -rf /tmp/dist

      - name: ğŸ“¤ ç›´æ¥ä¸Šä¼ æ„å»ºæ–‡ä»¶åˆ°ç›®æ ‡ç›®å½•
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: 'dist/*'
          target: '/root/www/visualmedical.org/'
          strip_components: 1

      - name: ğŸ”§ è®¾ç½®æƒé™
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            # è®¾ç½®æ­£ç¡®çš„æƒé™
            chmod -R 755 /root/www/visualmedical.org
            sudo chown -R root:www-data /root/www/visualmedical.org
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"

      # - name: ğŸ”„ é‡è½½ Nginx
      #   if: success()
      #   uses: appleboy/ssh-action@v1.0.0
      #   with:
      #     host: ${{ secrets.HOST }}
      #     username: ${{ secrets.USERNAME }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       echo "ğŸ”„ é‡è½½ Nginx..."
      #       if sudo nginx -t; then
      #         sudo systemctl reload nginx
      #         echo "âœ… Nginx é‡è½½æˆåŠŸ"
      #       else
      #         echo "âŒ Nginx é…ç½®æµ‹è¯•å¤±è´¥"
      #         exit 1
      #       fi

      - name: ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "ğŸ‰ ç½‘ç«™å·²æˆåŠŸéƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.HOST }}"

      - name: âŒ éƒ¨ç½²å¤±è´¥å¤„ç†
        if: failure()
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œæ¸…ç†ä¸´æ—¶æ–‡ä»¶..."

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf /tmp/website-build /tmp/visualmedical.org_deploy.sh /tmp/dist
            
            echo "âš ï¸ è¯·æ£€æŸ¥éƒ¨ç½²æ—¥å¿—å¹¶æ‰‹åŠ¨å¤„ç†"
