---
import GoogleAnalytics from "@components/analytics/GoogleAnalytics.astro";
import MicrosoftClarity from "@components/analytics/MicrosoftClarity.astro";
import FancyboxManager from "@components/features/FancyboxManager.astro";
import FontManager from "@components/features/FontManager.astro";
import KatexManager from "@components/features/KatexManager.astro";
import MusicPlayer from "@components/features/MusicPlayer.astro";
import SakuraEffect from "@components/features/SakuraEffect.astro";
import ConfigCarrier from "@components/layout/ConfigCarrier.astro";
import FestivalDecoration from "@components/features/FestivalDecoration.astro";
import GlobalIconSprite from "@/components/misc/GlobalIconSprite.astro";

import {
	backgroundWallpaper,
	expressiveCodeConfig,
	profileConfig,
	siteConfig,
} from "@/config";
import {
	BANNER_HEIGHT,
	BANNER_HEIGHT_EXTEND,
	BANNER_HEIGHT_HOME,
	PAGE_WIDTH,
} from "@/constants/constants";
import { defaultFavicons } from "@/constants/icon";
import type { Favicon } from "@/types/config";
import { getDefaultBackground, isHomePage } from "@/utils/layout-utils";
import { url } from "@/utils/url-utils";
import { shouldApplyGrayscale } from "@/utils/festival-manager";

import "@/styles/navbar.css";
import "@/styles/layout-styles.css";
import "@/styles/waves.css";
import "@/styles/grayscale.css";
import "@/styles/main.css";
import "@rehype-callouts-theme";

interface Props {
	title?: string;
	banner?: string;
	description?: string;
	lang?: string;
	setOGTypeArticle?: boolean;
	postSlug?: string;
}

let { title, banner, description, lang, setOGTypeArticle, postSlug } =
	Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
// Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change
// so use Swup hooks instead to change the height immediately when a link is clicked
const isHomePageCheck = isHomePage(Astro.url.pathname);

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;

// 获取导航栏透明模式配置
const navbarTransparentMode =
	backgroundWallpaper.banner?.navbar?.transparentMode || "semi";
// 判断是否应该显示顶部高光效果（只在full和semifull模式下显示）
const shouldShowTopHighlight =
	navbarTransparentMode === "full" || navbarTransparentMode === "semifull";

if (!banner || typeof banner !== "string" || banner.trim() === "") {
	banner = getDefaultBackground();
}

const enableBanner =
	backgroundWallpaper.mode === "banner" &&
	(isHomePageCheck || !!postSlug);
const pageType = isHomePageCheck ? "home" : postSlug ? "post" : "page";

let pageTitle: string;
if (title) {
	pageTitle = `${title} - ${siteConfig.title}`;
} else {
	pageTitle = siteConfig.subtitle
		? `${siteConfig.title} - ${siteConfig.subtitle}`
		: siteConfig.title;
}

let ogImageUrl: string | undefined;
if (siteConfig.generateOgImages && postSlug) {
	ogImageUrl = new URL(`/og/${postSlug}.png`, Astro.site).toString();
}

const favicons: Favicon[] =
	siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
	lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

// 使用固定的banner偏移量，position配置用于图片定位
const bannerOffset = `${BANNER_HEIGHT_EXTEND / 2}vh`;

// 检查是否应该启用全站变灰
const isGrayscaleEnabled = shouldApplyGrayscale(siteConfig.grayscale);
---

<!doctype html>
<html lang={siteLang} class="bg-[var(--page-bg)] text-[14px] md:text-[16px]" data-default-wallpaper={backgroundWallpaper.mode}>
  <head>
      {siteConfig.analytics?.enableGoogleAnalytics && siteConfig.analytics?.googleAnalyticsId && (
              <GoogleAnalytics analyticsId={siteConfig.analytics.googleAnalyticsId} />
      )}
      {siteConfig.analytics?.microsoftClarityId && (
              <MicrosoftClarity clarityId={siteConfig.analytics.microsoftClarityId} />
      )}

    <title>{pageTitle}</title>

    <meta charset="UTF-8" />
    <meta
      name="description"
      content={description || siteConfig.description || pageTitle}
    />
    {
      siteConfig.keywords && siteConfig.keywords.length > 0 && (
        <meta name="keywords" content={siteConfig.keywords.join(", ")} />
      )
    }
    <meta name="author" content={profileConfig.name} />

    <meta property="og:site_name" content={siteConfig.title} />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={pageTitle} />
    <meta
      property="og:description"
      content={description || siteConfig.description || pageTitle}
    />
    {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
    {
      setOGTypeArticle ? (
        <meta property="og:type" content="article" />
      ) : (
        <meta property="og:type" content="website" />
      )
    }

    <meta name="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta name="twitter:title" content={pageTitle} />
    <meta
      name="twitter:description"
      content={description || siteConfig.description || pageTitle}
    />

    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    {
      favicons.map((favicon) => (
        <link
          rel="icon"
          href={favicon.src.startsWith("/") ? url(favicon.src) : favicon.src}
          sizes={favicon.sizes}
          media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
        />
      ))
    }

    <!-- Set the theme before the page is rendered to avoid a flash -->
    <script
      is:inline
      define:vars={{
        BANNER_HEIGHT_EXTEND,
        PAGE_WIDTH,
        configHue,
        defaultMode: siteConfig.themeColor.defaultMode ?? "light",
        defaultWallpaperMode: backgroundWallpaper.mode,
        defaultBannerTitleEnabled: backgroundWallpaper.banner?.homeText?.enable ?? false,
        isWallpaperSwitchable:
          backgroundWallpaper.switchable ?? true,
        darkTheme: expressiveCodeConfig.darkTheme,
        lightTheme: expressiveCodeConfig.lightTheme,
        baseUrl: import.meta.env.BASE_URL,
      }}
    >
      // 主题初始化 - 与setting-utils.ts保持一致
      const LIGHT_MODE = "light";
      const DARK_MODE = "dark";
      const SYSTEM_MODE = "system";

      // 获取存储的主题，如果没有则使用默认值
      const theme = localStorage.getItem("theme") || defaultMode;
      // 记录“主题模式”（light/dark/system），用于纯 CSS 控制按钮图标，避免刷新时按钮闪烁/重载感
      document.documentElement.setAttribute("data-theme-mode", theme);

      // 获取系统主题
      function getSystemTheme() {
        return window.matchMedia("(prefers-color-scheme: dark)").matches
          ? DARK_MODE
          : LIGHT_MODE;
      }

      // 解析主题（如果是system模式，则获取系统主题）
      function resolveTheme(themeValue) {
        if (themeValue === SYSTEM_MODE) {
          return getSystemTheme();
        }
        return themeValue;
      }

      const resolvedTheme = resolveTheme(theme);
      const isDark = resolvedTheme === DARK_MODE;

      // 应用主题
      if (isDark) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }

      // Set the theme for Expressive Code
      document.documentElement.setAttribute(
        "data-theme",
        isDark ? darkTheme : lightTheme
      );
      // 暴露给后续纯脚本按钮使用（避免组件/模块加载导致按钮短暂不一致）
      document.documentElement.dataset.expressiveDarkTheme = darkTheme;
      document.documentElement.dataset.expressiveLightTheme = lightTheme;

      // Load the hue from local storage
      const hue = localStorage.getItem("hue") || configHue;
      document.documentElement.style.setProperty("--hue", hue);

      // calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
      // 使用更准确的窗口高度计算
      function calculateBannerHeightExtend() {
        let offset = Math.floor(
          window.innerHeight * (BANNER_HEIGHT_EXTEND / 100)
        );
        offset = offset - (offset % 4);
        document.documentElement.style.setProperty(
          "--banner-height-extend",
          `${offset}px`
        );
      }

      // 立即设置初始值
      calculateBannerHeightExtend();

      // 在下一帧重新计算精确值（仅在值变化时更新，避免闪烁）
      requestAnimationFrame(() => {
        const oldValue = parseInt(
          document.documentElement.style.getPropertyValue(
            "--banner-height-extend"
          )
        );
        calculateBannerHeightExtend();
        const newValue = parseInt(
          document.documentElement.style.getPropertyValue(
            "--banner-height-extend"
          )
        );
        // 如果值变化了，再更新一次确保准确
        if (Math.abs(oldValue - newValue) > 4) {
          // 如果有明显变化，延迟一帧再更新，避免闪烁
          requestAnimationFrame(calculateBannerHeightExtend);
        }
      });

      // 初始化壁纸模式 - 在页面渲染前应用
      const WALLPAPER_BANNER = "banner";
      const WALLPAPER_OVERLAY = "overlay";
      const WALLPAPER_NONE = "none";
      // 配置为 overlay 时强制使用 overlay，不读 localStorage，避免刷新仍显示 banner
      const stored = isWallpaperSwitchable ? localStorage.getItem("wallpaperMode") : null;
      const wallpaperMode =
        defaultWallpaperMode === WALLPAPER_OVERLAY
          ? WALLPAPER_OVERLAY
          : (stored || defaultWallpaperMode);

      // 设置data-wallpaper-mode属性
      document.documentElement.setAttribute(
        "data-wallpaper-mode",
        wallpaperMode
      );

      // 先同步设置 body 类，避免首屏闪 banner
      if (wallpaperMode === WALLPAPER_NONE || wallpaperMode === WALLPAPER_OVERLAY) {
        if (document.body) {
          document.body.classList.remove("enable-banner");
          document.body.classList.add("no-banner-layout");
        }
        if (wallpaperMode === WALLPAPER_OVERLAY && document.body) {
          document.body.classList.add("wallpaper-transparent");
        }
      } else if (document.body) {
        document.body.classList.add("enable-banner");
        document.body.classList.remove("no-banner-layout", "wallpaper-transparent");
      }

      // DOM 就绪后再处理 banner/overlay 元素（此时 #banner-wrapper 已存在）
      function runWallpaperVisibility() {
        // 使用 requestAnimationFrame 确保在下一帧之前执行
        requestAnimationFrame(function () {
          // 根据模式隐藏显示对应元素
          if (
            wallpaperMode === WALLPAPER_NONE ||
            wallpaperMode === WALLPAPER_OVERLAY
          ) {
            // 隐藏横幅
            if (document.body) {
              document.body.classList.remove("enable-banner");
              document.body.classList.add("no-banner-layout");
            }
          } else {
            if (document.body) {
              document.body.classList.add("enable-banner");
              document.body.classList.remove("no-banner-layout");
            }
          }

          // 全屏壁纸模式
          if (wallpaperMode === WALLPAPER_OVERLAY) {
            if (document.body) {
              document.body.classList.add("wallpaper-transparent");
            }
          } else {
            if (document.body) {
              document.body.classList.remove("wallpaper-transparent");
            }
          }

          // 处理banner和overlay wallpaper的显示
          const bannerWrapper = document.getElementById("banner-wrapper");
          const overlayWallpaper = document.querySelector(
            "[data-overlay-wallpaper]"
          );

          function isHomePath(pathname) {
            const baseNoSlash = baseUrl !== "/" ? baseUrl.replace(/\/$/, "") : "/";
            return (
              pathname === baseUrl ||
              (baseUrl !== "/" && pathname === baseNoSlash) ||
              pathname === "/"
            );
          }

          function isPostPath(pathname) {
            const baseNoSlash = baseUrl !== "/" ? baseUrl.replace(/\/$/, "") : "";
            const postsPrefix = `${baseNoSlash}/posts/`;
            return pathname.startsWith(postsPrefix);
          }

          function normalizePathname(pathname) {
            const baseNoSlash = baseUrl !== "/" ? baseUrl.replace(/\/$/, "") : "";
            if (baseNoSlash && pathname.startsWith(baseNoSlash)) {
              const rest = pathname.slice(baseNoSlash.length);
              return rest === "" ? "/" : rest;
            }
            return pathname;
          }

          const pathname = window.location.pathname;
          const isHomePage = isHomePath(pathname);
          const isPostPage =
            (document.body &&
              document.body.dataset &&
              document.body.dataset.pageType === "post") ||
            isPostPath(pathname);
          const isMobile = window.innerWidth < 1024;
          const mobilePostNoWallpaper = isMobile && isPostPage;

          // 壁纸模式优先级最高：
          // - 用户设置为 overlay/none 时，全站遵循该模式，不再强制显示横幅
          // - 文章详情页在移动端统一不显示壁纸（保持原有体验）
          const effectiveWallpaperMode = mobilePostNoWallpaper
            ? WALLPAPER_NONE
            : wallpaperMode;

          if (document.body) {
            if (mobilePostNoWallpaper) {
              // 移动端文章详情页：强制纯色背景（无 banner / 无 overlay）
              document.body.classList.remove("enable-banner", "wallpaper-transparent");
              document.body.classList.add("no-banner-layout");
            }
            // 其他情况统一交由前面的壁纸模式逻辑处理，确保壁纸模式具有最高优先级
          }

          if (effectiveWallpaperMode === WALLPAPER_OVERLAY) {
            // 全屏壁纸透明模式：显示全屏壁纸，隐藏banner
            if (bannerWrapper) {
              bannerWrapper.style.display = "none";
            }
            if (overlayWallpaper) {
              overlayWallpaper.style.display = "block";
              overlayWallpaper.classList.remove("hidden", "opacity-0");
              overlayWallpaper.classList.add("opacity-100");
            }
          } else if (effectiveWallpaperMode === WALLPAPER_NONE) {
            // 纯色背景：隐藏所有壁纸
            if (bannerWrapper) {
              bannerWrapper.style.display = "none";
            }
            if (overlayWallpaper) {
              overlayWallpaper.style.display = "none";
              overlayWallpaper.classList.add("hidden", "opacity-0");
            }
          } else {
            // banner模式：显示banner，隐藏全屏壁纸
            if (bannerWrapper) {
              // 移动端非首页时隐藏banner（初始状态直接隐藏，不需要动画）
              // 桌面端始终显示banner
              if (isMobile && !isHomePage) {
                bannerWrapper.style.display = "none";
                bannerWrapper.classList.add("mobile-hide-banner");
              } else {
                bannerWrapper.style.display = "block";
                bannerWrapper.classList.remove("mobile-hide-banner");
              }
            }
            if (overlayWallpaper) {
              overlayWallpaper.style.display = "none";
              overlayWallpaper.classList.add("hidden", "opacity-0");
            }
          }

          // 处理主内容区域位置
          const mainContentWrapper = document.querySelector(
            ".absolute.w-full.z-30"
          );
          if (mainContentWrapper) {
            // 只在移动端非首页时调整主内容位置
            if (isMobile && !isHomePage) {
              mainContentWrapper.classList.add("mobile-main-no-banner");
            } else {
              mainContentWrapper.classList.remove("mobile-main-no-banner");
            }
          }

          // 处理credit元素
          const creditDesktop = document.getElementById(
            "banner-credit-desktop"
          );
          const creditMobile = document.getElementById("banner-credit-mobile");
          if (
            effectiveWallpaperMode === WALLPAPER_OVERLAY ||
            effectiveWallpaperMode === WALLPAPER_NONE
          ) {
            if (creditDesktop) creditDesktop.style.display = "none";
            if (creditMobile) creditMobile.style.display = "none";
          } else {
            if (creditDesktop) creditDesktop.style.display = "";
            if (creditMobile) creditMobile.style.display = "";
          }


          // 处理banner文字元素显示/隐藏
          // 所有 overlay 现在都通过条件渲染，但需要用 JS 控制 hidden 类
          const bannerTextOverlays = document.querySelectorAll(
            "[data-banner-text-overlay]"
          );
          bannerTextOverlays.forEach((el) => {
            const overlayType = el.getAttribute("data-banner-text-overlay");
            // 仅在 banner 模式下，首页显示主页横幅文字
            const shouldShow =
              effectiveWallpaperMode === WALLPAPER_BANNER &&
              overlayType === "home" &&
              isHomePage;
            
            if (shouldShow) {
              el.classList.remove("hidden");
            } else {
              el.classList.add("hidden");
            }
          });
        });
      }
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", runWallpaperVisibility);
      } else {
        runWallpaperVisibility();
      }
      // 初始化水波纹动画状态 - 在 html 元素上设置属性，CSS 会立即生效
      (function applyWavesEnabled() {
        const wavesEnabled = localStorage.getItem("wavesEnabled");
        if (wavesEnabled !== null) {
          document.documentElement.setAttribute("data-waves-enabled", wavesEnabled);
        }
      })();

      // 初始化横幅标题显示状态 - 在 html 元素上设置属性，CSS 会立即生效
      (function applyBannerTitleEnabled() {
        const stored = localStorage.getItem("bannerTitleEnabled");
        const enabled = stored !== null ? stored : String(defaultBannerTitleEnabled);
        document.documentElement.setAttribute("data-banner-title-enabled", enabled);
      })();
    </script>
    <style
      define:vars={{
        configHue,
        "page-width": `${PAGE_WIDTH}rem`,
      }}
    ></style>
    <!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->

    <slot name="head" />

    <link
      rel="alternate"
      type="application/rss+xml"
      title={profileConfig.name}
      href={`${Astro.site}rss.xml`}
    />

    <!-- Font Manager -->
    <FontManager />
  </head>
  <body
    class="min-h-screen"
    class:list={[
      {
        "lg:is-home": isHomePageCheck,
        "enable-banner": enableBanner,
        "no-banner-layout": !enableBanner,
        "enable-card-border": siteConfig.card?.border,
        "grayscale-mode": isGrayscaleEnabled,
      },
      ...(siteConfig.font.enable && siteConfig.font.selected
        ? (Array.isArray(siteConfig.font.selected)
            ? siteConfig.font.selected
            : [siteConfig.font.selected]
          ).map((fontId) => `font-${fontId}-enabled`)
        : []),
    ]}
    data-page-type={pageType}
  >
    <!-- 壁纸模式：body 存在后立即设置类，避免文章详情页刷新时 banner 区域闪白 -->
    <script
      is:inline
      define:vars={{
        defaultWallpaperMode: backgroundWallpaper.mode,
        isWallpaperSwitchable: backgroundWallpaper.switchable ?? true,
      }}
    >
      (function () {
        const WALLPAPER_OVERLAY = "overlay";
        const WALLPAPER_NONE = "none";
        const stored = isWallpaperSwitchable && typeof localStorage !== "undefined"
          ? localStorage.getItem("wallpaperMode")
          : null;
        const mode = defaultWallpaperMode === WALLPAPER_OVERLAY
          ? WALLPAPER_OVERLAY
          : (stored || defaultWallpaperMode);
        if (mode === WALLPAPER_OVERLAY || mode === WALLPAPER_NONE) {
          document.body.classList.remove("enable-banner");
          document.body.classList.add("no-banner-layout");
          if (mode === WALLPAPER_OVERLAY) {
            document.body.classList.add("wallpaper-transparent");
          }
        } else {
          document.body.classList.add("enable-banner");
          document.body.classList.remove("no-banner-layout", "wallpaper-transparent");
        }
      })();
    </script>
    <!-- 固化 astro-icon 的 symbol sprite，避免 Swup 局部替换后 <use> 找不到 <symbol> 导致图标空白 -->
    <GlobalIconSprite />

    <div id="progress-bar"></div>

    <!-- 页面顶部渐变高光效果 - 只在full和semifull模式下显示 -->
    {shouldShowTopHighlight && <div class="top-gradient-highlight" />}
    <ConfigCarrier />
    <slot />

    <!-- Music Player -->
    <MusicPlayer />

    <!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
    <div id="page-height-extend" class="hidden h-[300vh]"></div>

    <!-- Sakura Effect -->
    <SakuraEffect />

    <!-- Fancybox Manager -->
    <FancyboxManager />
    
    <!-- KaTeX Manager -->
    <KatexManager />

    <!-- Festival Decoration -->
    <FestivalDecoration />
  </body>
</html>

<style
  is:global
  define:vars={{
    bannerOffset,
    "banner-height-home": `${BANNER_HEIGHT_HOME}vh`,
    "banner-height": `${BANNER_HEIGHT}vh`,
  }}
>
  /* 默认 overlay/none 时首屏即隐藏横幅，避免刷新闪出 */
  /* 同时支持 data-wallpaper-mode（用户通过 localStorage 切换后的运行时值） */
  html[data-default-wallpaper="overlay"] #banner-wrapper,
  html[data-default-wallpaper="none"] #banner-wrapper,
  html[data-wallpaper-mode="overlay"] #banner-wrapper,
  html[data-wallpaper-mode="none"] #banner-wrapper {
    display: none !important;
    visibility: hidden !important;
    height: 0 !important;
    min-height: 0 !important;
    overflow: hidden !important;
    pointer-events: none !important;
  }
  @tailwind components;
  @layer components {
    /* 首页：用 data-page-type 判断，避免类名不匹配 */
    body.enable-banner[data-page-type="home"] #banner-wrapper {
      @apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)];
    }
    /* 文章页，壁纸显示高度与首页一致 */
    body.enable-banner[data-page-type="post"] #banner-wrapper {
      @apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)];
    }
    .enable-banner #banner-wrapper {
      @apply h-[var(--banner-height-home)];
    }

    body.enable-banner[data-page-type="home"] #banner {
      @apply h-[var(--banner-height-home)] translate-y-0;
    }
    body.enable-banner[data-page-type="post"] #banner {
      @apply h-[var(--banner-height-home)] translate-y-0;
    }
    .enable-banner #banner {
      @apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)];
    }
    body.enable-banner[data-page-type="home"] #main-grid {
      @apply translate-y-[var(--banner-height-extend)];
    }
    body.enable-banner[data-page-type="post"] #main-grid {
      @apply translate-y-[var(--banner-height-extend)];
    }
    .enable-banner #top-row {
      @apply h-[4.5rem] transition-all duration-300;
    }
    body.enable-banner[data-page-type="home"] #sidebar-sticky,
    body.enable-banner[data-page-type="home"] #left-sidebar-sticky,
    body.enable-banner[data-page-type="home"] #right-sidebar-sticky,
    body.enable-banner[data-page-type="post"] #sidebar-sticky,
    body.enable-banner[data-page-type="post"] #left-sidebar-sticky,
    body.enable-banner[data-page-type="post"] #right-sidebar-sticky {
      top: 1rem;
    }
  }
</style>

<script>
  import { pathsEqual, url } from "@/utils/url-utils";
  import {
    BANNER_HEIGHT,
    BANNER_HEIGHT_EXTEND,
    // MAIN_PANEL_OVERLAPS_BANNER_HEIGHT,
  } from "@/constants/constants";
  import { backgroundWallpaper, expressiveCodeConfig, siteConfig } from "@/config";

  /* Preload fonts */
  // (async function() {
  // 	try {
  // 		await Promise.all([
  // 			document.fonts.load("400 1em Roboto"),
  // 			document.fonts.load("700 1em Roboto"),
  // 		]);
  // 		document.body.classList.remove("hidden");
  // 	} catch (error) {
  // 		console.log("Failed to load fonts:", error);
  // 	}
  // })();

  /* TODO This is a temporary solution for style flicker issue when the transition is activated */
  /* issue link: https://github.com/withastro/astro/issues/8711, the solution get from here too */
  /* update: fixed in Astro 3.2.4 */
  /*
function disableAnimation() {
	const css = document.createElement('style')
	css.appendChild(
		document.createTextNode(
			`*{
              -webkit-transition:none!important;
              -moz-transition:none!important;
              -o-transition:none!important;
              -ms-transition:none!important;
              transition:none!important
              }`
		)
	)
	document.head.appendChild(css)

	return () => {
		// Force restyle
		;(() => window.getComputedStyle(document.body))()

		// Wait for next tick before removing
		setTimeout(() => {
			document.head.removeChild(css)
		}, 1)
	}
}
*/

  const bannerEnabled = !!document.getElementById("banner-wrapper");

  function setClickOutsideToClose(panel: string, ignores: string[]) {
      document.addEventListener("click", (event) => {
          let panelDom = document.getElementById(panel);
          if (!panelDom) return;
          let tDom = event.target;
          if (!(tDom instanceof Node)) return; // Ensure the event target is an HTML Node
          for (let ig of ignores) {
              let ie = document.getElementById(ig);
              if (ie == tDom || ie?.contains(tDom)) {
                  return;
              }
          }
          panelDom.classList.add("float-panel-closed");
      });
  }
  setClickOutsideToClose("display-setting", [
    "display-setting",
    "display-settings-switch",
  ]);
  setClickOutsideToClose("nav-menu-panel", [
    "nav-menu-panel",
    "nav-menu-switch",
  ]);
  setClickOutsideToClose("search-panel", [
    "search-panel",
    "search-bar",
    "search-switch",
  ]);
  setClickOutsideToClose("wallpaper-mode-panel", [
    "wallpaper-mode-panel",
    "wallpaper-mode-switch",
  ]);
  setClickOutsideToClose("theme-mode-panel", [
    "theme-mode-panel",
    "scheme-switch",
  ]);

  function initCustomScrollbar() {
    // 只处理katex元素的滚动条，使用浏览器原生滚动条
    const katexElements = document.querySelectorAll(
      ".katex-display:not([data-scrollbar-initialized])"
    ) as NodeListOf<HTMLElement>;
    katexElements.forEach((element) => {
      if (!element.parentNode) return;

      const container = document.createElement("div");
      container.className = "katex-display-container";
      element.parentNode.insertBefore(container, element);
      container.appendChild(element);

      // 使用浏览器原生滚动条，无自定义样式
      container.style.cssText = `
			overflow-x: auto;
		`;

      element.setAttribute("data-scrollbar-initialized", "true");
    });
  }

  function showBanner() {
    const isBannerMode = backgroundWallpaper.mode === "banner";
    if (!isBannerMode) return;

    // 使用requestAnimationFrame优化DOM操作
    requestAnimationFrame(() => {
      // Handle single image banner (desktop)
      const banner = document.getElementById("banner");
      if (banner) {
        banner.classList.remove("opacity-0", "scale-105");
      }

      // Handle mobile single image banner - 使用与电脑端相同的逻辑
      const mobileBanner = document.querySelector(
        '.block.lg\\:hidden[alt="Mobile banner image of the blog"]'
      );
      if (mobileBanner) {
        // 移动端使用与电脑端相同的初始化逻辑
        mobileBanner.classList.remove("opacity-0", "scale-105");
        mobileBanner.classList.add("opacity-100");
      }
    });
  }

  const setup = () => {
    // TODO: temp solution to change the height of the banner
    /*
	window.swup.hooks.on('animation:out:start', () => {
		const path = window.location.pathname
		const body = document.querySelector('body')
		if (path[path.length - 1] === '/' && !body.classList.contains('is-home')) {
			body.classList.add('is-home')
		} else if (path[path.length - 1] !== '/' && body.classList.contains('is-home')) {
			body.classList.remove('is-home')
		}
	})
*/
    window.swup.hooks.on("link:click", (_visit: any, { el }: { el: HTMLAnchorElement }) => {
      // Remove the delay for the first time page load
      document.documentElement.style.setProperty("--content-delay", "0ms");

      // 同页链接点击不需要过渡保护
      const targetHref = el?.getAttribute("href") || "";
      const targetPathname = (() => {
        try {
          return new URL(targetHref, window.location.origin).pathname;
        } catch {
          return targetHref;
        }
      })();
      const isSamePage = pathsEqual(targetPathname, window.location.pathname);
      if (!isSamePage) {
        // 添加页面切换保护，防止导航栏闪烁
        document.documentElement.classList.add("is-page-transitioning");
      }

      // 说明：此前这里会在滚动到 banner 下方时隐藏导航栏（navbar-hidden）。
      // 用户需求为“导航栏固定且不随滚动消失”，因此不再在滚动/点击时自动隐藏导航栏。
    });
    window.swup.hooks.on("content:replace", () => {
      // 更新主网格布局类名
      const gridClassCarrier = document.getElementById("grid-class-carrier");
      if (gridClassCarrier) {
        const gridClass = gridClassCarrier.getAttribute("data-grid-class");
        const mainGrid = document.getElementById("main-grid");
        if (mainGrid && gridClass) {

          const currentClasses = mainGrid.className.split(" ");
          const newClasses = currentClasses.filter(c => !c.startsWith("lg:grid-cols-") && !c.startsWith("md:grid-cols-") && !c.startsWith("grid-cols-"));
          
          // 添加新的网格类
          const gridClasses = gridClass.split(" ");
          mainGrid.className = [...newClasses, ...gridClasses].join(" ");
        }
      }

      // 处理 banner overlay 的显示（Swup 替换后需要根据壁纸模式重新设置）
      const pageType = document.body?.dataset?.pageType;
      const isHomePage = pageType === "home";
      const isPostPage = pageType === "post";
      const docEl = document.documentElement;
      const wallpaperMode =
        docEl.getAttribute("data-wallpaper-mode") || "banner";
      const WALLPAPER_BANNER = "banner";
      const WALLPAPER_NONE = "none";
      const WALLPAPER_OVERLAY = "overlay";
      const isMobile = window.innerWidth < 1024;
      const mobilePostNoWallpaper = isMobile && isPostPage;
      const effectiveWallpaperMode = mobilePostNoWallpaper
        ? WALLPAPER_NONE
        : wallpaperMode;
      
      const bannerTextOverlays = document.querySelectorAll("[data-banner-text-overlay]");
      bannerTextOverlays.forEach((el) => {
        const overlayType = el.getAttribute("data-banner-text-overlay");
        const shouldShow =
          effectiveWallpaperMode === WALLPAPER_BANNER &&
          overlayType === "home" &&
          isHomePage;
        
        if (shouldShow) {
          el.classList.remove("hidden");
        } else {
          el.classList.add("hidden");
        }
      });

      // 只处理katex元素的容器，使用浏览器原生滚动条
      initCustomScrollbar();
      
      // 重新初始化图标加载器
      import("@/utils/icon-loader").then(({ initIconLoader }) => {
        initIconLoader();
      });

      // 检查当前页面是否为文章页面（有TOC元素）
      const tocWrapper = document.getElementById("toc-wrapper");
      const isArticlePage = tocWrapper !== null;

      // 只在文章页面重新初始化桌面端 TOC 组件
      if (isArticlePage) {
        const tocElement = document.querySelector("table-of-contents");
        if (tocElement && typeof (tocElement as any).init === "function") {
          setTimeout(() => {
            (tocElement as any).init();
          }, 100);
        }
      }

      // 重新初始化semifull模式的滚动检测
      const navbar = document.getElementById("navbar");
      if (navbar) {
        const transparentMode = navbar.getAttribute("data-transparent-mode");

        if (transparentMode === "semifull") {
          // 重新调用初始化函数来重新绑定滚动事件
          if (
            typeof (window as any).initSemifullScrollDetection === "function"
          ) {
            (window as any).initSemifullScrollDetection();
          }
        }
      }

    });
    window.swup.hooks.on("visit:start", (visit: {
      to: { url: string };
      history?: { popstate?: boolean; direction?: string };
      scroll?: { reset?: boolean };
    }) => {
      // 离开页面前保存滚动位置（用于回退时恢复）
      const currentKey = "swup-scroll:" + (window.location.pathname + window.location.search + window.location.hash);
      try {
        sessionStorage.setItem(currentKey, String(window.scrollY || document.documentElement.scrollTop));
      } catch (_e) { /* ignore */ }

      // 回退/前进时：禁止 Swup 重置滚动，交由下方 page:view 恢复
      if (visit.history?.popstate) {
        if (visit.scroll) visit.scroll.reset = false;
      }

      // Start progress bar
      const progressBar = document.getElementById("progress-bar");
      if (progressBar) {
        progressBar.classList.remove("finishing", "done");
        // Force reflow so the animation restarts cleanly
        void progressBar.offsetWidth;
        progressBar.classList.add("loading");
      }

      // change banner height immediately when a link is clicked
      const bodyElement = document.querySelector("body");
      const isHomePage = pathsEqual(visit.to.url, url("/"));
      const toPathname = new URL(visit.to.url, window.location.href).pathname;
      const isPostPage = /\/posts\/.+/.test(toPathname);
      const nextPageType = isHomePage ? "home" : isPostPage ? "post" : "page";
      if (bodyElement) {
        bodyElement.dataset.pageType = nextPageType;

        const docEl = document.documentElement;
        const wallpaperMode =
          docEl.getAttribute("data-wallpaper-mode") || "banner";
        const isMobile = window.innerWidth < 1024;

        if (isMobile && isPostPage) {
          // 移动端文章详情页：强制纯色背景（提前设置，避免跳转闪一下）
          bodyElement.classList.remove("enable-banner", "wallpaper-transparent");
          bodyElement.classList.add("no-banner-layout");
        } else if ((isHomePage || isPostPage) && wallpaperMode === "banner") {
          // 壁纸模式：首页和文章页启用 banner 布局
          bodyElement.classList.add("enable-banner");
          bodyElement.classList.remove(
            "no-banner-layout",
            "wallpaper-transparent"
          );
        } else {
          // 其他页面（归档、友链等）：无横幅布局
          bodyElement.classList.remove("enable-banner", "wallpaper-transparent");
          bodyElement.classList.add("no-banner-layout");
        }
      }

      if (isHomePage) {
        bodyElement!.classList.add("lg:is-home");
      } else {
        bodyElement!.classList.remove("lg:is-home");
      }

      // Banner-wrapper 已经被 Swup 替换，overlay 会根据新页面自动更新
      // 这里不需要手动处理 page overlay，它已经通过条件渲染正确显示

      // Control navbar transparency based on page
      const navbar = document.getElementById("navbar");
      if (navbar) {
        navbar.setAttribute("data-is-home", isHomePage.toString());

        // 重新初始化semifull模式的滚动检测
        const transparentMode = navbar.getAttribute("data-transparent-mode");
        if (transparentMode === "semifull") {
          // 重新调用初始化函数来重新绑定滚动事件
          if (
            typeof (window as any).initSemifullScrollDetection === "function"
          ) {
            (window as any).initSemifullScrollDetection();
          }
        }
      }

      // Control mobile banner visibility based on page with improved staging animation
      // 只在移动端（1024px以下）处理banner隐藏
      const isMobile = window.innerWidth < 1024;
      
      // 在移动端禁用文章列表容器的过渡动画，防止与主内容区位置变化冲突
      if (isMobile) {
        const postListContainer = document.getElementById("post-list-container");
        if (postListContainer) {
          postListContainer.style.transition = "none";
        }
      }

      const bannerWrapper = document.getElementById("banner-wrapper");
      const mainContentWrapper = document.querySelector(
        ".absolute.w-full.z-30"
      ) as HTMLElement | null;

      if (isMobile && bannerWrapper && mainContentWrapper) {
        // 移动端文章详情页：统一不显示壁纸/banner
        if (isPostPage) {
          bannerWrapper.classList.add("mobile-hide-banner");
          setTimeout(() => {
            mainContentWrapper.classList.add("mobile-main-no-banner");
          }, 0);
        } else if (isHomePage) {
          // 首页：禁用主内容区域的过渡动画，防止文章列表下移
          mainContentWrapper.style.transition = "none";
          
          // 先显示banner，然后移除隐藏类让其优雅出现
          bannerWrapper.style.display = "";
          setTimeout(() => {
            bannerWrapper.classList.remove("mobile-hide-banner");
          }, 100);
          setTimeout(() => {
            mainContentWrapper.classList.remove("mobile-main-no-banner");
            // 在移除类之后立即恢复过渡动画（下次导航时使用）
            setTimeout(() => {
              mainContentWrapper.style.transition = "";
            }, 50);
          }, 150);
        } else {
          // 非首页：分阶段隐藏，先隐藏banner，再移动内容
          bannerWrapper.classList.add("mobile-hide-banner");
          // 延迟移动内容，让banner先完全消失
          setTimeout(() => {
            mainContentWrapper.classList.add("mobile-main-no-banner");
          }, 100);
        }
      } else if (!isMobile && bannerWrapper) {
        // 桌面端：在横幅模式下首页和文章页显示 banner
        const docEl = document.documentElement;
        const wallpaperMode =
          docEl.getAttribute("data-wallpaper-mode") || "banner";
        if ((isHomePage || isPostPage) && wallpaperMode === "banner") {
          bannerWrapper.style.display = "block";
        } else {
          bannerWrapper.style.display = "";
        }
        bannerWrapper.classList.remove("mobile-hide-banner");
        if (mainContentWrapper) {
          mainContentWrapper.classList.remove("mobile-main-no-banner");
        }
      }

      // increase the page height during page transition to prevent the scrolling animation from jumping
      const heightExtend = document.getElementById("page-height-extend");
      if (heightExtend) {
        heightExtend.classList.remove("hidden");
      }

      // Hide the TOC while scrolling back to top
      let toc = document.getElementById("toc-wrapper");
      if (toc) {
        toc.classList.add("toc-not-ready");
      }
    });
    window.swup.hooks.on("page:view", (visit?: {
      history?: { popstate?: boolean };
    }) => {
      // hide the temp high element when the transition is done
      const heightExtend = document.getElementById("page-height-extend");
      if (heightExtend) {
        heightExtend.classList.remove("hidden");
      }

      // 回退/前进：恢复之前保存的滚动位置；新页面：滚动到顶部
      const isHistoryNav = visit?.history?.popstate === true;
      const restoreKey = "swup-scroll:" + (window.location.pathname + window.location.search + window.location.hash);

      if (isHistoryNav) {
        let savedY: number | null = null;
        try {
          const stored = sessionStorage.getItem(restoreKey);
          if (stored != null) {
            savedY = parseInt(stored, 10);
            sessionStorage.removeItem(restoreKey);
          }
        } catch (_e) { /* ignore */ }

        if (savedY != null && !isNaN(savedY) && savedY > 0) {
          const maxY = Math.max(0, document.documentElement.scrollHeight - window.innerHeight);
          // 下一帧恢复，确保 DOM 已布局
          requestAnimationFrame(() => {
            window.scrollTo(0, Math.min(savedY!, maxY));
          });
        }
      } else {
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // 在移动端恢复文章列表容器的过渡动画（在主内容区位置动画完成后）
      const isMobile = window.innerWidth < 1024;
      if (isMobile) {
        setTimeout(() => {
          const postListContainer = document.getElementById("post-list-container");
          if (postListContainer) {
            postListContainer.style.transition = "";
          }
        }, 600); // 等待主内容区动画完成（0.4s + 0.1s delay + 100ms buffer）
      }

      // 同步主题状态 - 解决从首页进入文章页面时代码块渲染问题
      const storedTheme = localStorage.getItem("theme") || siteConfig.themeColor.defaultMode || "light";
      let isDark = false;
      
      // 处理 system 模式
      if (storedTheme === "system") {
        isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      } else {
        isDark = storedTheme === "dark";
      }
      
      const expectedTheme = isDark
        ? expressiveCodeConfig.darkTheme
        : expressiveCodeConfig.lightTheme;
      const currentTheme = document.documentElement.getAttribute("data-theme");

      // 如果主题不匹配，静默更新（不触发事件，避免重新加载效果）
      if (currentTheme !== expectedTheme) {
        document.documentElement.setAttribute("data-theme", expectedTheme);
      }

      // 检查当前页面是否为文章页面，如果是则触发自定义事件用于初始化评论系统
      setTimeout(() => {
        if (document.getElementById("tcomment")) {
          // 触发自定义事件，通知评论系统页面已完全加载
          const pageLoadedEvent = new CustomEvent("firefly:page:loaded", {
            detail: {
              path: window.location.pathname,
              timestamp: Date.now(),
            },
          });
          document.dispatchEvent(pageLoadedEvent);
        }
      }, 300);
    });
    window.swup.hooks.on("visit:end", (_visit: { to: { url: string } }) => {
      // Finish progress bar
      const progressBar = document.getElementById("progress-bar");
      if (progressBar) {
        progressBar.classList.remove("loading");
        progressBar.classList.add("finishing");
        setTimeout(() => {
          progressBar.classList.remove("finishing");
          progressBar.classList.add("done");
          setTimeout(() => {
            progressBar.classList.remove("done");
          }, 300);
        }, 200);
      }
      setTimeout(() => {
        const heightExtend = document.getElementById("page-height-extend");
        if (heightExtend) {
          heightExtend.classList.add("hidden");
        }

        // Just make the transition looks better
        const toc = document.getElementById("toc-wrapper");
        if (toc) {
          toc.classList.remove("toc-not-ready");
        }

        // 移除页面切换保护，恢复过渡动画
        document.documentElement.classList.remove("is-page-transitioning");
      }, 200);
    });


  };
  if (window?.swup?.hooks) {
    setup();
  } else {
    document.addEventListener("swup:enable", setup);
  }

  let toc = document.getElementById("toc-wrapper");

  // 优化的滚动处理函数
  function scrollFunction() {
    const scrollTop = document.documentElement.scrollTop;
    const bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100);

    // 使用批量DOM操作优化性能
    const operations: (() => void)[] = [];

    if (bannerEnabled && toc) {
      operations.push(() => {
        if (scrollTop > bannerHeight) {
          toc.classList.remove("toc-hide");
        } else {
          toc.classList.add("toc-hide");
        }
      });
    }

    // 导航栏不再随滚动隐藏（保持始终可见）

    // 批量执行DOM操作
    if (operations.length > 0) {
      requestAnimationFrame(() => {
        operations.forEach((op) => op());
      });
    }
  }

  // 使用优化的滚动性能处理
  let scrollTimeout: number;
  window.addEventListener(
    "scroll",
    () => {
      if (scrollTimeout) {
        cancelAnimationFrame(scrollTimeout);
      }
      scrollTimeout = requestAnimationFrame(scrollFunction);
    },
    { passive: true }
  );

  window.onresize = () => {
    // calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
    let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
    offset = offset - (offset % 4);
    document.documentElement.style.setProperty(
      "--banner-height-extend",
      `${offset}px`
    );
  };

  // 页面加载完成后初始化banner和katex容器
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      showBanner();
      initCustomScrollbar();
    });
  } else {
    showBanner();
    initCustomScrollbar();
  }

  // Initialize wallpaper mode
  import { initWallpaperMode, initThemeListener } from "@/utils/setting-utils";
  import { initIconLoader } from "@/utils/icon-loader";
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      initWallpaperMode();
      initThemeListener();
      initIconLoader();
    });
  } else {
    initWallpaperMode();
    initThemeListener();
    initIconLoader();
  }
</script>
