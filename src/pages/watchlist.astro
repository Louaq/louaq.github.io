---
import Icon from "@/components/misc/Icon.astro";
import ClientPagination from "@/components/common/ClientPagination.astro";
import TabNav from "@/components/pages/watchlist/TabNav.astro";
import { siteConfig } from "@/config";
import { watchlistConfig, type WatchlistItem } from "@/config/watchlistConfig";
import I18nKey from "@/i18n/i18nKey";
import { i18n } from "@/i18n/translation";
import MainGridLayout from "@/layouts/MainGridLayout.astro";

// 检查页面是否启用
if (!siteConfig.pages.watchlist) {
	return Astro.redirect("/404/");
}

// 获取启用的观影项目
const enabledItems = watchlistConfig.items.filter((item) => item.enabled);

// 按播出时间排序的函数
const sortByDate = (a: WatchlistItem, b: WatchlistItem) => {
	const dateA = a.startDate || a.endDate || "";
	const dateB = b.startDate || b.endDate || "";
	return dateB.localeCompare(dateA); // 降序，最新的在前
};

// 按类型分类并排序
const categorizedItems = {
	anime: enabledItems.filter(item => item.type === "anime").sort(sortByDate),
	movie: enabledItems.filter(item => item.type === "movie").sort(sortByDate),
	tv: enabledItems.filter(item => item.type === "tv").sort(sortByDate),
	documentary: enabledItems.filter(item => item.type === "documentary").sort(sortByDate),
	other: enabledItems.filter(item => item.type === "other").sort(sortByDate),
};

// 分类配置（按照指定顺序）
const categories = [
	{ key: "anime", name: i18n(I18nKey.watchlistCategoryAnime), icon: "material-symbols:movie", items: categorizedItems.anime },
	{ key: "movie", name: i18n(I18nKey.watchlistCategoryMovie), icon: "material-symbols:theaters", items: categorizedItems.movie },
	{ key: "tv", name: i18n(I18nKey.watchlistCategoryTV), icon: "material-symbols:tv", items: categorizedItems.tv },
	{ key: "documentary", name: i18n(I18nKey.watchlistCategoryDocumentary), icon: "material-symbols:documentary", items: categorizedItems.documentary },
	{ key: "other", name: i18n(I18nKey.watchlistCategoryOther), icon: "material-symbols:category", items: categorizedItems.other },
].filter(category => category.items.length > 0); // 只显示有内容的分类

// 准备标签页数据
const tabs = categories.map(category => ({
	id: category.key,
	name: category.name,
	count: category.items.length,
}));

const activeTab = tabs[0]?.id || "anime";

// 每页显示的数量
const itemsPerPage = 6;

// 获取构建时间
const buildTime = new Date().toLocaleString("zh-CN", {
	year: "numeric",
	month: "2-digit",
	day: "2-digit",
	hour: "2-digit",
	minute: "2-digit",
});

// 状态文本映射
const statusText = {
	watching: "观看中",
	completed: "已完成",
	plan_to_watch: "计划观看",
};

// 类型文本映射
const typeText = {
	anime: "动漫",
	movie: "电影",
	tv: "电视剧",
	documentary: "纪录片",
	other: "其他",
};

// 状态颜色映射
const statusColor = {
	watching: "text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20",
	completed:
		"text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20",
	plan_to_watch:
		"text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-900/20",
};
---

<MainGridLayout
	title={i18n(I18nKey.watchlistTitle)}
	description={i18n(I18nKey.watchlistSubtitle)}
>
	<div
		class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32"
	>
		<div class="card-base z-10 px-9 pt-6 pb-1 relative w-full">
			<!-- 页面标题 -->
			<div class="relative w-full mb-8">
				<div class="mb-6">
					<div class="flex items-center gap-3 mb-3">
						<div
							class="h-8 w-8 rounded-lg bg-[var(--primary)] flex items-center justify-center text-white dark:text-black/70"
						>
							<Icon icon="material-symbols:video-library" class="text-[1.5rem]"
							></Icon>
						</div>
						<h1
							class="text-3xl font-bold text-neutral-900 dark:text-neutral-100"
						>
							{i18n(I18nKey.watchlistTitle)}
						</h1>
					</div>
					<p
						class="text-base text-neutral-600 dark:text-neutral-400 leading-relaxed"
					>
						{i18n(I18nKey.watchlistSubtitle)}
					</p>
					<p class="text-xs text-neutral-500 dark:text-neutral-500 mt-2">
						{i18n(I18nKey.watchlistLastUpdated)} {buildTime}
					</p>
				</div>

			<!-- Tab 导航和内容 -->
			{
				tabs.length > 0 ? (
					<>
						<TabNav tabs={tabs} activeTab={activeTab} />

						<!-- 内容区域 -->
						{categories.map((category) => (

							<div
								class:list={["category-section", { hidden: category.key !== activeTab }]}
								data-section={category.key}
							>
								{/* 分类内容网格容器 */}
								<div class="pagination-container" data-container-section={category.key}>
									<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
										{category.items.map((item: WatchlistItem) => (
										<div 
											class="group relative bg-white dark:bg-neutral-800 rounded-xl overflow-hidden shadow-sm hover:shadow-2xl transition-all duration-500 border border-neutral-200 dark:border-neutral-700 block cursor-default"
											data-item-section={category.key}>
											{/* 封面图 */}
											<div class="relative aspect-[3/4] overflow-hidden bg-neutral-100 dark:bg-neutral-900">
												<img
													src={item.cover}
													alt={item.title}
													class="w-full h-full object-cover pointer-events-none"
													loading="lazy"
												/>
												{/* 评分 */}
												{watchlistConfig.display.showRating && item.rating && item.rating > 0 && (
													<div class="absolute top-2 right-2">
														<div class="flex items-center gap-1 px-2 py-1 rounded-md bg-black/60 text-white backdrop-blur-sm">
															<Icon
																icon="material-symbols:star"
																class="text-yellow-400 text-sm"
															/>
															<span class="text-xs font-bold">{item.rating}</span>
														</div>
													</div>
												)}
												{/* 状态标签 */}
												<div class="absolute top-2 left-2">
													<span
														class={`px-2 py-1 text-xs font-medium rounded-md ${statusColor[item.status]}`}
													>
														{statusText[item.status]}
													</span>
												</div>
											</div>

											{/* 悬浮时显示的信息覆盖层 */}
											<div class="absolute inset-x-0 bottom-0 bg-black/85 text-white p-4 transform translate-y-full group-hover:translate-y-0 transition-transform duration-500">
												{/* 标题 */}
												<h3 class="text-base font-bold mb-2 line-clamp-2">
													{item.title}
												</h3>

												{/* 类型标签 */}
												<div class="mb-2">
													<span class="px-2 py-1 text-xs font-medium rounded-md bg-white/20 text-white">
														{typeText[item.type]}
													</span>
												</div>

												{/* 观看进度 */}
												{watchlistConfig.display.showProgress &&
													item.episodes &&
													item.episodes.total && (
														<div class="mb-2">
															<div class="flex items-center justify-between text-xs text-white/80 mb-1">
																<span>观看进度</span>
																<span>
																	{item.episodes.current || 0}/{item.episodes.total}
																</span>
															</div>
															<div class="w-full bg-white/20 rounded-full h-1.5">
																<div
																	class="bg-[var(--primary)] h-1.5 rounded-full transition-all duration-300"
																	style={{
																		width: `${((item.episodes.current || 0) / item.episodes.total) * 100}%`,
																	}}
																/>
															</div>
														</div>
													)}

												{/* 评价 */}
												{item.comment && (
													<p class="text-sm text-white/90 mb-2 line-clamp-2">
														{item.comment}
													</p>
												)}

												{/* 标签 */}
												{item.tags && item.tags.length > 0 && (
													<div class="flex flex-wrap gap-1.5 mb-2">
														{item.tags.slice(0, 3).map((tag) => (
															<span class="px-2 py-0.5 text-xs rounded-full bg-white/20 text-white/90">
																{tag}
															</span>
														))}
														{item.tags.length > 3 && (
															<span class="px-2 py-0.5 text-xs rounded-full bg-white/20 text-white/60">
																+{item.tags.length - 3}
															</span>
														)}
													</div>
												)}

												{/* 观看日期 */}
												{(item.startDate || item.endDate) && (
													<div class="text-xs text-white/70">
														{item.status === "completed" && item.endDate ? (
															<span>完成于 {item.endDate}</span>
														) : item.startDate ? (
															<span>开始于 {item.startDate}</span>
														) : null}
													</div>
												)}
											</div>
										</div>
									))}
								</div>

								{/* 分页控件 */}
								<ClientPagination
									totalItems={category.items.length}
									itemsPerPage={itemsPerPage}
									currentPage={1}
									sectionId={category.key}
								/>
								</div>
							</div>
						))}
					</>
				) : (
					<div class="text-center py-16">
						<div class="inline-flex items-center justify-center w-16 h-16 bg-[var(--btn-regular-bg)] rounded-full mb-6 border border-[var(--line-divider)]">
							<Icon
								icon="material-symbols:video-library"
								class="text-[2rem] text-[var(--btn-content)]"
							/>
						</div>
						<h2 class="text-xl font-semibold text-black/80 dark:text-white/80 mb-3">
							{i18n(I18nKey.watchlistEmpty)}
						</h2>
						<p class="text-black/60 dark:text-white/60 mb-4 max-w-md mx-auto">
							{i18n(I18nKey.watchlistEmptyReason)}
						</p>
					</div>
				)
			}
			</div>
		</div>
	</div>
</MainGridLayout>

<style>
	/* 自定义样式 */
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.category-section {
		animation: fadeIn 0.3s ease-in-out;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	/* 固定分页容器高度，防止切换页面时高度变化 */
	.pagination-container {
		/* 移除固定高度，让容器根据内容自适应 */
	}

	/* 为卡片添加淡入淡出过渡效果 */
	.pagination-container [data-item-section] {
		transition: opacity 0.2s ease-in-out;
	}

	/* 确保悬浮层正确显示 */
	.pagination-container a[data-item-section] {
		position: relative;
		overflow: hidden;
	}
</style>

