---
import { getAlbum, scanAlbums } from "../../utils/album-scanner";
import MainGridLayout from "../../layouts/MainGridLayout.astro";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";

// 获取路由参数
const { id } = Astro.params;

// 获取相册数据
const album = await getAlbum(id as string);

// 如果相册不存在，返回404
if (!album) {
  return Astro.redirect("/404");
}

// 为静态站点生成提供所有可能的路径
export async function getStaticPaths() {
  const albums = await scanAlbums();
  return albums.map(album => ({
    params: { id: album.id },
  }));
}
---

<MainGridLayout title={album.title} description={album.description || ""}>
  <!-- 顶部封面区域 -->
  <div class="relative w-full mb-6 rounded-[var(--radius-large)] overflow-hidden album-hero">
    <img
      src={album.cover || album.photos[0]?.src}
      alt={album.title}
      class="absolute inset-0 w-full h-full object-cover"
      loading="lazy"
    />
    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>

    <div class="relative z-10 h-full flex flex-col justify-between px-5 py-4 md:px-9 md:py-6">
      <!-- 返回按钮 -->
      <div class="mb-4">
        <a 
          href="/albums/" 
          class="inline-flex items-center gap-2 text-neutral-100/90 hover:text-white transition-colors text-sm"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          返回相册列表
        </a>
      </div>

      <!-- 标题与信息 -->
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-white mb-3">
          {album.title}
        </h1>

        {album.description && (
          <p class="text-sm md:text-base text-white/85 mb-4 max-w-2xl">
            {album.description}
          </p>
        )}

        <div class="flex flex-wrap items-center gap-4 text-xs md:text-sm text-white/80">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
            </svg>
            {album.photos.length} {album.photos.length > 1 ? i18n(I18nKey.albumsPhotosCount) : i18n(I18nKey.albumsPhotoCount)}
          </span>

          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
            </svg>
            {new Date(album.date).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}
          </span>

          {album.location && (
            <span class="flex items-center gap-1">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
              </svg>
              {album.location}
            </span>
          )}
        </div>

        {album.tags && album.tags.length > 0 && (
          <div class="flex flex-wrap gap-2 mt-4">
            {album.tags.map(tag => (
              <span class="inline-flex items-center h-7 text-xs px-3 rounded-full bg-white/15 text-white/90 backdrop-blur-sm">
                {tag}
              </span>
            ))}
          </div>
        )}
      </div>
    </div>
  </div>

  <!-- 照片容器卡片 -->
  <div class="card-base px-5 py-5 md:px-9 md:py-6 rounded-[var(--radius-large)]">
    <div id="photo-container" class={album.layout === 'grid' ? 'photo-grid' : 'photo-masonry'}>
      {album.photos.map((photo, index) => (
        <a 
          href={photo.src}
          data-fancybox="gallery"
          data-caption={photo.title ? `${photo.title}${photo.description ? ` - ${photo.description}` : ''}` : photo.description || ''}
          class="photo-item group relative overflow-hidden rounded-lg bg-neutral-100 dark:bg-neutral-800 block"
        >
          <img 
            src={photo.src}
            alt={photo.title || `Photo ${index + 1}`}
            class="w-full h-auto object-cover transition-transform duration-300 group-hover:scale-105"
            loading="lazy"
          />
          
          {(photo.title || photo.description) && (
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
                {photo.title && (
                  <h3 class="font-semibold mb-1 text-sm md:text-base">{photo.title}</h3>
                )}
                {photo.description && (
                  <p class="text-xs md:text-sm text-white/90 line-clamp-2">{photo.description}</p>
                )}
              </div>
            </div>
          )}
        </a>
      ))}
    </div>

    {album.photos.length === 0 && (
      <div class="text-center py-12">
        <div class="text-neutral-400 dark:text-neutral-600 mb-4">
          <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
        </div>
        <p class="text-neutral-600 dark:text-neutral-400">
          这个相册还没有照片
        </p>
      </div>
    )}
  </div>
</MainGridLayout>

<style>
  .album-hero {
    min-height: 220px;
  }

  @media (min-width: 768px) {
    .album-hero {
      min-height: 260px;
    }
  }

  /* 瀑布流布局 */
  .photo-masonry {
    column-count: 3;
    column-gap: 1rem;
  }

  @media (max-width: 1024px) {
    .photo-masonry {
      column-count: 2;
    }
  }

  @media (max-width: 640px) {
    .photo-masonry {
      column-count: 1;
    }
  }

  .photo-masonry .photo-item {
    break-inside: avoid;
    margin-bottom: 1rem;
  }

  /* 网格布局 */
  .photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
  }

  @media (max-width: 768px) {
    .photo-grid {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 0.5rem;
    }
  }

  .photo-grid .photo-item {
    aspect-ratio: 1 / 1;
  }

  .photo-grid .photo-item img {
    height: 100%;
    object-fit: cover;
  }

  /* 通用样式 */
  .photo-item {
    cursor: pointer;
    transition: transform 0.2s ease-out;
  }

  .photo-item:hover {
    transform: translateY(-2px);
  }

  .photo-item img {
    will-change: transform;
    display: block;
  }

  /* 动画 */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .photo-item {
    animation: fadeIn 0.3s ease-out;
    animation-fill-mode: both;
  }

  .photo-item:nth-child(1) { animation-delay: 0.05s; }
  .photo-item:nth-child(2) { animation-delay: 0.1s; }
  .photo-item:nth-child(3) { animation-delay: 0.15s; }
  .photo-item:nth-child(4) { animation-delay: 0.2s; }
  .photo-item:nth-child(5) { animation-delay: 0.25s; }
  .photo-item:nth-child(6) { animation-delay: 0.3s; }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

<script>
  // Fancybox 已由全局 `src/components/effects/FancyboxManager.astro` 统一初始化
  // 这里避免重复 bind（重复预加载/解码可能触发 EncodingError 且表现为未捕获 Promise）
</script>

