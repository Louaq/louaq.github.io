---
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
	class?: string;
	style?: string;
}

const { class: className, style } = Astro.props;
---

<WidgetLayout id="random-poetry-widget" name="随机诗词" class={className} style={style}>
  <div class="random-poetry-container">
    <div id="random-poetry-content" class="poetry-content">
      <!-- 诗词内容将由脚本动态插入 -->
    </div>
  </div>
</WidgetLayout>

<script is:inline>
  function initRandomPoetry() {
    // 清除之前可能存在的脚本
    const oldScript = document.getElementById('random-poetry-api-script');
    if (oldScript) {
      oldScript.remove();
    }

    // 动态加载诗词 API 脚本
    const script = document.createElement('script');
    script.id = 'random-poetry-api-script';
    script.type = 'text/javascript';
    script.src = 'https://api.yviii.com/yiyan/ci.php/?syz=js&charset=utf-8';
    
    script.onload = function() {
      // 脚本加载完成后，检查 hici 函数是否存在
      if (typeof window.hici === 'function') {
        // 重定向输出到我们的容器
        const container = document.getElementById('random-poetry-content');
        if (container) {
          // 保存原始的 document.write
          const originalWrite = document.write;
          let capturedContent = '';
          
          // 临时替换 document.write
          document.write = function(content) {
            capturedContent += content;
          };
          
          // 调用 hici() 函数
          window.hici();
          
          // 恢复原始的 document.write
          document.write = originalWrite;
          
          // 将捕获的内容插入到容器中
          if (capturedContent) {
            container.innerHTML = capturedContent;
          }
        }
      }
    };
    
    script.onerror = function() {
      console.error('Failed to load random poetry API');
      const container = document.getElementById('random-poetry-content');
      if (container) {
        container.innerHTML = '<p class="text-neutral-500 dark:text-neutral-400 text-sm text-center">诗词加载失败</p>';
      }
    };
    
    document.head.appendChild(script);
  }

  // 页面加载时初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initRandomPoetry);
  } else {
    initRandomPoetry();
  }

  // 页面切换时重新加载
  document.addEventListener("swup:contentReplaced", () => {
    setTimeout(initRandomPoetry, 100);
  });
</script>

<style>
  .random-poetry-container {
    display: flex;
    flex-direction: column;
  }

  .poetry-content {
    min-height: 60px;
    color: var(--primary-text-color);
    line-height: 1.8;
    text-align: center;
    padding: 0.5rem 0;
  }

  /* 美化诗词内容 */
  .poetry-content :global(p) {
    margin: 0.5rem 0;
    color: var(--primary-text-color);
  }

  .poetry-content :global(a) {
    color: var(--primary);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .poetry-content :global(a:hover) {
    color: oklch(0.7 0.16 var(--hue));
    text-decoration: underline;
  }

  /* 响应式调整 */
  @media (max-width: 768px) {
    .poetry-content {
      font-size: 0.9rem;
    }
  }
</style>

