---
import type { MarkdownHeading } from "astro";
import Advertisement from "@/components/widget/Advertisement.astro";
import Announcement from "@/components/widget/Announcement.astro";
import Calendar from "@/components/widget/Calendar.astro";
import Categories from "@/components/widget/Categories.astro";
import Countdown from "@/components/widget/Countdown.astro";
import DouyinHot from "@/components/widget/DouyinHot.astro";
import Profile from "@/components/widget/Profile.astro";
import RecentComments from "@/components/widget/RecentComments.astro";
import SidebarTOC from "@/components/widget/SidebarTOC.astro";
import SiteStats from "@/components/widget/SiteStats.astro";
import Tags from "@/components/widget/Tags.astro";
import type { WidgetComponentConfig } from "@/types/config";
import { widgetManager } from "@/utils/widget-manager";

interface Props {
	class?: string;
	headings?: MarkdownHeading[];
}

const { class: className, headings } = Astro.props;

// 判断当前页面是否为文章页面（服务端渲染时确定），用于设置组件初始隐藏状态避免闪烁
const isPostPage = Astro.url.pathname.includes("/posts/");

// 获取配置的侧边栏位置
const sidebarPosition = widgetManager.getConfig().position;
const targetSidebar = sidebarPosition === "left" ? "left" : undefined;

// 获取配置的组件列表 - 根据 position 配置决定显示哪一侧
const topComponents = widgetManager.getComponentsByPosition(
	"top",
	targetSidebar,
);
const stickyComponents = widgetManager.getComponentsByPosition(
	"sticky",
	targetSidebar,
);

// 组件类型到ID的映射
const componentTypeToId = {
	stats: "site-stats",
	calendar: "calendar-widget",
	countdown: "countdown-widget",
	sidebarToc: "sidebar-toc",
	profile: "profile",
	announcement: "announcement",
	categories: "categories",
	tags: "tags",
	advertisement: "advertisement",
	douyinHot: "douyin-hot",
	recentComments: "recent-comments",
};

// 提取组件的 showOnPostPage 配置
const componentsConfig = (() => {
	const components =
		targetSidebar === "left"
			? widgetManager.getConfig().leftComponents
			: [
					...widgetManager.getConfig().leftComponents,
					...widgetManager.getConfig().rightComponents,
				];

	return components
		.filter((c) => c.enable)
		.map((c) => ({
			id: componentTypeToId[c.type as keyof typeof componentTypeToId],
			showOnPostPage: c.showOnPostPage ?? true,
			showOnNonPostPage: c.showOnNonPostPage ?? true,
		}));
})();

// 组件映射表
const componentMap = {
	profile: Profile,
	announcement: Announcement,
	categories: Categories,
	tags: Tags,
	sidebarToc: SidebarTOC,
	advertisement: Advertisement,
	stats: SiteStats,
	calendar: Calendar,
	countdown: Countdown,
	douyinHot: DouyinHot,
	recentComments: RecentComments,
};

// 渲染组件的辅助函数
function renderComponent(
	component: WidgetComponentConfig,
	index: number,
	_components: WidgetComponentConfig[],
) {
	const ComponentToRender =
		componentMap[component.type as keyof typeof componentMap];
	if (!ComponentToRender) return null;

	// 使用配置的侧边栏位置，如果是 both 则默认为 left
	const sidebar = targetSidebar || "left";
	const componentClass = widgetManager.getComponentClass(
		component,
		sidebar,
		index,
	);
	const componentStyle = widgetManager.getComponentStyle(component, index);

	// 根据 showOnPostPage / showOnNonPostPage 在服务端设置初始 hidden 状态，避免页面加载时闪烁
	// 同时添加标记 class，方便调试或后续扩展
	let finalClass = componentClass;
	if (component.showOnPostPage === false) {
		finalClass = `${finalClass} widget-hide-on-post`;
		if (isPostPage) {
			finalClass = `${finalClass} hidden`;
		}
	}
	if (component.showOnNonPostPage === false) {
		finalClass = `${finalClass} widget-hide-on-non-post`;
		if (!isPostPage) {
			finalClass = `${finalClass} hidden`;
		}
	}

	// Sidebar TOC 只在文章详情页显示：服务端先隐藏非文章页，避免首屏闪烁
	if (component.type === "sidebarToc" && !isPostPage) {
		finalClass = `${finalClass} hidden`;
	}

	return {
		Component: ComponentToRender,
		props: {
			class: finalClass,
			style: componentStyle,
			headings: headings ?? [],
			configId: component.configId, // 传递configId给Advertisement组件
			...component.customProps,
		},
	};
}
---

<div id="sidebar" class:list={[className, "w-full"]}>
  <!-- 顶部固定组件区域 -->
  {
    topComponents.length > 0 && (
      <div class="flex flex-col w-full gap-4 mb-4">
        {topComponents.map((component, index) => {
          const renderData = renderComponent(component, index, topComponents);
          if (!renderData) return null;

          const { Component, props } = renderData;
          return <Component {...props} />;
        })}
      </div>
    )
  }

  <!-- 粘性组件区域 -->
  {
    stickyComponents.length > 0 && (
      <div
        id="sidebar-sticky"
        class="transition-all duration-700 flex flex-col w-full gap-4 sticky top-4"
      >
        {stickyComponents.map((component, index) => {
          const renderData = renderComponent(
            component,
            index,
            stickyComponents
          );
          if (!renderData) return null;

          const { Component, props } = renderData;
          return <Component {...props} />;
        })}
      </div>
    )
  }
</div>

<!-- JavaScript：根据 showOnPostPage 控制组件显示 -->
<script is:inline define:vars={{ componentsConfig }}>
  // 根据 showOnPostPage 配置控制组件显示
  function toggleComponentsVisibility() {
    const isPostPage = window.location.pathname.includes("/posts/");
    
    const sidebar = document.getElementById('sidebar');
    if (!sidebar) return;
    
    const widgets = sidebar.querySelectorAll('widget-layout');
    
    widgets.forEach((widget) => {
      const widgetId = widget.getAttribute('data-id');
      const componentConfig = componentsConfig.find(c => c.id === widgetId);
      
      if (componentConfig) {
        // 特殊处理：侧边栏TOC只在文章详情页显示
        if (widgetId === 'sidebar-toc') {
          widget.style.display = isPostPage ? '' : 'none';
        }
        // 其他组件的 showOnPostPage 含义：
        // true: 在文章页和非文章页都显示（默认行为）
        // false: 只在非文章页显示，文章页隐藏
        else {
          if (isPostPage && componentConfig.showOnPostPage === false) {
            widget.style.display = 'none';
          } else if (!isPostPage && componentConfig.showOnNonPostPage === false) {
            widget.style.display = 'none';
          } else {
            widget.style.display = '';
          }
        }
      }
    });
  }

  // 页面加载时执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      toggleComponentsVisibility();
    });
  } else {
    toggleComponentsVisibility();
  }

  // 监听SWUP内容替换事件（如果存在）
  if (typeof window !== "undefined" && window.swup) {
    window.swup.hooks.on("content:replace", () => {
      // 延迟执行以确保DOM已更新
      setTimeout(() => {
        toggleComponentsVisibility();
      }, 100);
    });
  }
</script>
